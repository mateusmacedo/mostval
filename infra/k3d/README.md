# k3d-dev - Ambiente de Desenvolvimento Kubernetes (Single Node)

Ambiente de desenvolvimento Kubernetes otimizado usando k3d, ideal para desenvolvimento local com recursos limitados.

## üöÄ In√≠cio R√°pido

### 1. Configura√ß√£o Inicial

```bash
# Clone o reposit√≥rio
git clone <repository-url>
cd k3d-dev

# Gere senhas seguras automaticamente
make generate-passwords

# Verifique depend√™ncias
make deps
```

### 2. Criar o Ambiente Base

```bash
# Crie o cluster k3d
make up

# Deploy da infraestrutura
make deploy-mostval

# Configure ingress centralizado
make setup-centralized-ingress
```

### 3. Inicializar Cluster Existente

Se voc√™ j√° tem um cluster criado e precisa apenas inicializ√°-lo:

```bash
# Inicializa cluster existente
make start
```

## üìã Comandos Dispon√≠veis

### Comandos B√°sicos

| Comando | Descri√ß√£o |
|---------|-----------|
| `make help` | Lista todos os comandos dispon√≠veis |
| `make deps` | Verifica depend√™ncias (docker, k3d, kubectl) |
| `make up` | Cria o cluster k3d single node e registry local |
| `make down` | Remove cluster e registry |
| `make start` | Inicializa cluster k3d existente |
| `make status` | Mostra status do cluster |
| `make test` | Testa conectividade do cluster |
| `make generate-passwords` | Gera senhas seguras automaticamente |

### Comandos de Infraestrutura

| Comando | Descri√ß√£o |
|---------|-----------|
| `make deploy-mostval` | Deploy da infraestrutura completa |
| `make setup-centralized-ingress` | Configura ingress centralizado (URL √∫nica) |
| `make test-centralized-ingress` | Testa ingress centralizado |
| `make revert-centralized-ingress` | Reverte para ingress individuais |

### Comandos de Teste

| Comando | Descri√ß√£o |
|---------|-----------|
| `make test` | Testa conectividade do cluster |
| `make test-registry` | Testa o registry local |
| `make test-ingress` | Testa ingress centralizado |
| `make test-all` | Executa todos os testes |

### Comandos de Build e Deploy

| Comando | Descri√ß√£o |
|---------|-----------|
| `make build-images` | Constr√≥i e faz push das imagens Docker (inteligente) |
| `make deploy-all` | Constr√≥i e implanta todas as aplica√ß√µes (inteligente) |
| `make smart-build` | Build inteligente com detec√ß√£o autom√°tica de contexto |
| `make smart-deploy` | Deploy inteligente com detec√ß√£o autom√°tica de contexto |

### Comandos de Seguran√ßa

| Comando | Descri√ß√£o |
|---------|-----------|
| `make apply-security` | Aplica pol√≠ticas de seguran√ßa |
| `make allow-app` | Permite ingress de uma nova aplica√ß√£o |

## üîß Configura√ß√£o

### Vari√°veis de Ambiente

Copie `env.example` para `.env` e ajuste conforme necess√°rio:

```bash
cp env.example .env
```

Principais vari√°veis:

- `CLUSTER_NAME`: Nome do cluster (padr√£o: dev)
- `K3S_VERSION`: Vers√£o do k3s (padr√£o: v1.29.5-k3s1)
- `REGISTRY_PORT`: Porta do registry local (padr√£o: 5001)
- `CLUSTER_PASSWORD`: Senha do cluster (gerada automaticamente)

## üéØ Caracter√≠sticas

### Vantagens do Ambiente Single Node

- **Baixo uso de recursos**: Otimizado com 16GB RAM
- **Configura√ß√£o r√°pida**: Setup em poucos comandos
- **F√°cil manuten√ß√£o**: Menos complexidade, mais estabilidade
- **Ideal para desenvolvimento**: Foco no que realmente importa
- **Otimizado para baixo or√ßamento**: Configura√ß√£o especial

### Configura√ß√£o

- **`cluster.yaml`**: Configura√ß√£o otimizada (16GB RAM, 1TB SSD)

### Fluxo de Uso Recomendado

```bash
# 1. Configura√ß√£o inicial
make generate-passwords
make deps

# 2. Criar cluster otimizado 
make up

# 3. Deploy da infraestrutura
make deploy-mostval

# 4. Configurar ingress centralizado
make setup-centralized-ingress

# 5. Testar funcionamento
make test-all
```

### Portas Expostas

- **80/443**: Ingress (Traefik)
- **6445**: API do Kubernetes
- **5001**: Registry local

## üåê Ingress Centralizado

### Vantagens

#### ‚úÖ **Antes (Ingress Individuais)**
```bash
# M√∫ltiplas entradas no /etc/hosts
127.0.0.1 auth.mostval.local
127.0.0.1 aws.mostval.local
127.0.0.1 rabbitmq.mostval.local
```

#### ‚úÖ **Depois (Ingress Centralizado)**
```bash
# Apenas uma entrada no /etc/hosts
127.0.0.1 mostval.local
```

### URLs de Acesso

| Servi√ßo | URL | Descri√ß√£o |
|---------|-----|-----------|
| **Dashboard** | https://mostval.local/ | P√°gina inicial com links para todos os servi√ßos |
| **Keycloak** | https://mostval.local/auth/ | Autentica√ß√£o e autoriza√ß√£o |
| **LocalStack** | https://mostval.local/aws/ | AWS Emulator |
| **RabbitMQ** | https://mostval.local/rabbitmq/ | Sistema de mensageria |
| **Health** | https://mostval.local/health | Verifica√ß√£o de sa√∫de |
| **Node.js API** | https://mostval.local/api/node/ | API Node.js (quando implantada) |
| **Go API** | https://mostval.local/api/go/ | API Go (quando implantada) |

### Configura√ß√£o do Ingress

```bash
# Aplicar o ingress centralizado
make setup-centralized-ingress

# Configurar /etc/hosts
echo '127.0.0.1 mostval.local' | sudo tee -a /etc/hosts

# Testar configura√ß√£o
make test-centralized-ingress
```

## üöÄ Scripts Inteligentes

### Problema Resolvido

#### **Antes (Scripts Legados)**
```bash
# Problema: localhost hardcoded
REGISTRY_URL="localhost:5001"  # ‚ùå Falha no cluster
docker push localhost:5001/app:latest  # ‚ùå N√£o funciona no cluster
```

#### **Depois (Scripts Inteligentes)**
```bash
# Solu√ß√£o: Detec√ß√£o autom√°tica de contexto
REGISTRY_URL=$(./scripts/07-utils.sh get-registry-url)  # ‚úÖ Funciona em qualquer contexto
docker push $REGISTRY_URL/app:latest  # ‚úÖ Funciona sempre
```

### Scripts Consolidados

| Script | Descri√ß√£o | Comandos |
|--------|-----------|----------|
| `01-cluster.sh` | Gerenciamento do cluster | create, start, delete, status |
| `02-registry.sh` | Registry + build/push inteligente | test, build |
| `03-deploy.sh` | Deploy da infraestrutura | deploy, status, logs, test |
| `04-ingress.sh` | Ingress centralizado | setup, revert, test |
| `05-security.sh` | Seguran√ßa e pol√≠ticas | apply, allow-app, status |
| `06-test.sh` | Testes consolidados | cluster, registry, ingress, connectivity, all |
| `07-utils.sh` | Utilit√°rios diversos | status, generate-passwords, create-secrets, get-registry-url |
| `08-deps.sh` | Depend√™ncias e configura√ß√£o | check, install, configure, info |

### Detec√ß√£o de Contexto

```bash
# Verifica se est√° rodando dentro de um pod Kubernetes
if [ -n "${KUBERNETES_SERVICE_HOST}" ]; then
    # Contexto: Cluster Kubernetes
    REGISTRY_URL="k3d-dev-registry:5000"
else
    # Contexto: Host local
    REGISTRY_URL="localhost:5001"
fi
```

## üîí Seguran√ßa

### Senhas Geradas Automaticamente

O comando `make generate-passwords` gera automaticamente:

- Senha do cluster k3d

### Pol√≠ticas de Seguran√ßa

- **NetworkPolicies b√°sicas**: Aplicadas automaticamente
- **PodSecurityStandards**: Configurados pelo k3s
- **Isolamento de rede**: Implementado via k3d

### Configura√ß√£o Segura

- Nunca commite o arquivo `.env` (est√° no `.gitignore`)
- Use secrets do Kubernetes para dados sens√≠veis
- Configure RBAC conforme necess√°rio para seu projeto

## üõ†Ô∏è Desenvolvimento

### Registry Local

O registry local est√° dispon√≠vel em `localhost:5001`:

```bash
# Tag uma imagem
docker tag minha-imagem:latest localhost:5001/minha-imagem:latest

# Push para o registry
docker push localhost:5001/minha-imagem:latest

# Pull no cluster
kubectl run test --image=localhost:5001/minha-imagem:latest
```

### Build e Deploy Inteligente

```bash
# Build de aplica√ß√£o espec√≠fica
./scripts/02-registry.sh build node-api
./scripts/02-registry.sh build go-api

# Deploy da infraestrutura
./scripts/03-deploy.sh deploy

# Testes completos
./scripts/06-test.sh all
```

## ‚òÅÔ∏è LocalStack (AWS Emulator)

### Acesso

- **URL**: https://mostval.local/aws/
- **Namespace**: `mostval`
- **Servi√ßos**: S3, SQS, DynamoDB, Lambda, IAM, STS, CloudFormation, API Gateway, Route53, Secrets Manager, SSM

### Configura√ß√£o

```bash
# Vari√°veis de ambiente para aplica√ß√µes
export AWS_DEFAULT_REGION=us-east-1
export AWS_ACCESS_KEY_ID=test
export AWS_SECRET_ACCESS_KEY=test
export LOCALSTACK_ENDPOINT=https://mostval.local/aws/
```

### Verificar Status

```bash
# Verificar se o LocalStack est√° rodando
kubectl get pods -n mostval -l app=localstack

# Verificar logs
kubectl logs -f deployment/localstack -n mostval

# Testar conectividade
curl -k https://mostval.local/aws/_localstack/health
```

## üê∞ RabbitMQ - Sistema de Mensageria

### Configura√ß√£o

#### Vari√°veis de Ambiente

```bash
# RabbitMQ Configuration
RABBITMQ_USER=mostval
RABBITMQ_PASSWORD=mostval123
RABBITMQ_VHOST=mostval_sites
RABBITMQ_ERLANG_COOKIE=mostval_cookie
RABBITMQ_URL=amqp://mostval:mostval123@rabbitmq.mostval.svc.cluster.local:5672/mostval_sites
```

#### Portas

- **5672**: AMQP (protocolo de mensageria)
- **15672**: Management UI (interface web)

### Estrutura de Mensageria

#### Exchanges

- **mostval.notifications**: Exchange para notifica√ß√µes (tipo: topic)
- **mostval.events**: Exchange para eventos de sistema (tipo: topic)

#### Filas

- **notifications.email**: Fila para emails
- **notifications.sms**: Fila para SMS
- **events.audit**: Fila para eventos de auditoria

#### Routing Keys

- **email.***: Mensagens de email
- **sms.***: Mensagens de SMS
- **audit.***: Eventos de auditoria

### Acesso

#### URLs de Desenvolvimento

- **Management UI**: https://mostval.local/rabbitmq/
- **AMQP**: rabbitmq.mostval.svc.cluster.local:5672

#### Credenciais

- **Usu√°rio**: mostval
- **Senha**: mostval123
- **VHost**: mostval_sites

## üîç Troubleshooting

### Cluster n√£o inicia

```bash
# Verifique se o Docker est√° rodando
docker info

# Verifique portas em uso
netstat -tuln | grep -E ":(80|443|5001|6445) "

# Limpe e recrie
make down
make up
```

### Cluster com problemas

```bash
# Verifique se o cluster est√° rodando
make status

# Teste conectividade
make test

# Verifique pods do sistema
kubectl get pods -n kube-system

# Verifique logs de pods com problemas
kubectl logs -n kube-system <nome-do-pod>
```

### Problemas de Conectividade

```bash
# Verifique se o kubeconfig est√° correto
kubectl config current-context

# Verifique se o cluster est√° acess√≠vel
kubectl cluster-info

# Recrie o cluster se necess√°rio
make down
make up
```

### Problemas de Ingress

```bash
# Verificar /etc/hosts
grep mostval.local /etc/hosts

# Adicionar se n√£o existir
echo '127.0.0.1 mostval.local' | sudo tee -a /etc/hosts

# Verificar status do ingress
kubectl get ingress -n mostval

# Verificar logs do Traefik
kubectl logs -f deployment/traefik -n kube-system
```

### Problemas de Registry

```bash
# Verificar se o registry est√° rodando
kubectl get pods -n kube-system | grep registry

# Verificar conectividade
kubectl exec -it deployment/nginx -n mostval -- curl http://k3d-dev-registry:5000/v2/

# Verificar URL do registry
./scripts/07-utils.sh get-registry-url
```

## üìÅ Estrutura do Projeto

```text
k3d-dev/
‚îú‚îÄ‚îÄ values/
‚îÇ   ‚îî‚îÄ‚îÄ cluster.yaml                    # Configura√ß√£o otimizada
‚îú‚îÄ‚îÄ manifests/
‚îÇ   ‚îú‚îÄ‚îÄ 00-namespace.yaml              # Namespace
‚îÇ   ‚îú‚îÄ‚îÄ 01-database.yaml               # PostgreSQL + Redis
‚îÇ   ‚îú‚îÄ‚îÄ 02-identity.yaml               # Keycloak
‚îÇ   ‚îú‚îÄ‚îÄ 03-messaging.yaml              # RabbitMQ
‚îÇ   ‚îú‚îÄ‚îÄ 04-aws-emulator.yaml           # LocalStack
‚îÇ   ‚îî‚îÄ‚îÄ 05-ingress.yaml                # Ingress centralizado
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ 01-cluster.sh                  # Gerenciamento do cluster
‚îÇ   ‚îú‚îÄ‚îÄ 02-registry.sh                 # Registry + build/push
‚îÇ   ‚îú‚îÄ‚îÄ 03-deploy.sh                   # Deploy da infraestrutura
‚îÇ   ‚îú‚îÄ‚îÄ 04-ingress.sh                  # Ingress centralizado
‚îÇ   ‚îú‚îÄ‚îÄ 05-security.sh                 # Seguran√ßa e pol√≠ticas
‚îÇ   ‚îú‚îÄ‚îÄ 06-test.sh                     # Testes consolidados
‚îÇ   ‚îú‚îÄ‚îÄ 07-utils.sh                    # Utilit√°rios diversos
‚îÇ   ‚îî‚îÄ‚îÄ 08-deps.sh                     # Depend√™ncias e configura√ß√£o
‚îú‚îÄ‚îÄ env.example                         # Exemplo de vari√°veis de ambiente
‚îú‚îÄ‚îÄ .gitignore                          # Arquivos ignorados
‚îú‚îÄ‚îÄ Makefile                            # Comandos principais
‚îî‚îÄ‚îÄ README.md                           # Este arquivo
```

## üí∞ Otimiza√ß√µes para Recursos Limitados

Este ambiente k3d est√° otimizado para desenvolvimento com recursos limitados:

- **Configura√ß√£o otimizada** para 16GB RAM
- **Single node** para simplicidade
- **Registry local** para desenvolvimento r√°pido
- **Ingress centralizado** para acesso unificado
- **Scripts inteligentes** para detec√ß√£o autom√°tica de contexto

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa MIT.